if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var t,e={};AFRAME.registerComponent("audioanalyser",{schema:{buffer:{default:!1},beatStartCutoff:{default:.8},beatEndCutoff:{default:.75},cache:{default:!1},enabled:{default:!0},enableBeatDetection:{default:!0},enableLevels:{default:!0},enableWaveform:{default:!0},enableVolume:{default:!0},fftSize:{default:2048},smoothingTimeConstant:{default:.8},src:{parse:function(t){return t.constructor!==String?t:t.startsWith("#")||t.startsWith(".")?document.querySelector(t):t}},unique:{default:!1}},init:function(){this.audioEl=null,this.levels=null,this.waveform=null,this.volume=0,this.xhr=null,this.beat_low=!1,this.beat_mid=!1,this.beat_high=!1,this.beat_low_max=20,this.beat_mid_max=20,this.beat_high_max=20,this.initContext()},update:function(t){var e=this.analyser,i=this.data;t.fftSize===i.fftSize&&t.smoothingTimeConstant===i.smoothingTimeConstant||(e.fftSize=i.fftSize,e.smoothingTimeConstant=i.smoothingTimeConstant,this.levels=new Uint8Array(e.frequencyBinCount),this.waveform=new Uint8Array(e.fftSize)),i.src&&this.refreshSource()},tick:function(t,e){var i=this.data;if(i.enabled){if((i.enableLevels||i.enableVolume)&&this.analyser.getByteFrequencyData(this.levels),i.enableWaveform&&this.analyser.getByteTimeDomainData(this.waveform),i.enableVolume||i.enableBeatDetection){for(var a=0,n=0;n<this.levels.length;n++)a+=this.levels[n];this.volume=a/this.levels.length}if(i.enableBeatDetection){var s=this.beatInRange(1,350,this.beat_low,this.beat_low_max,"audioanalyser-beat-low");this.beat_low=s[0],this.beat_low_max=s[1],s=this.beatInRange(500,2e3,this.beat_mid,this.beat_mid_max,"audioanalyser-beat-mid"),this.beat_mid=s[0],this.beat_mid_max=s[1],s=this.beatInRange(4e3,1e4,this.beat_high,this.beat_high_max,"audioanalyser-beat-high"),this.beat_high=s[0],this.beat_high_max=s[1]}}},beatInRange:function(t,e,i,a,n){var s=this.levels.length,o=Math.floor(t/23600*s),r=Math.floor(e/23600*s),h=this.levels.slice(o,r),u=h.reduce(function(t,e){return t+e})/h.length;return u>=(a=Math.max(u,a))*this.data.beatStartCutoff&&0==i?(this.el.emit(n,null,!1),[!0,a]):u<a*this.data.beatEndCutoff&&1==i?[!1,a]:[i,a]},initContext:function(){var t,e=this.data;this.context=new(window.webkitAudioContext||window.AudioContext),t=this.analyser=this.context.createAnalyser(),(this.gainNode=this.context.createGain()).connect(t),t.connect(this.context.destination),t.fftSize=e.fftSize,t.smoothingTimeConstant=e.smoothingTimeConstant,this.levels=new Uint8Array(t.frequencyBinCount),this.waveform=new Uint8Array(t.fftSize)},refreshSource:function(){var t=this,e=this.data;e.buffer&&e.src.constructor===String?this.getBufferSource().then(function(e){t.source=e,t.source.connect(t.gainNode)}):(this.source=this.getMediaSource(),this.source.connect(this.gainNode))},suspendContext:function(){this.context.suspend()},resumeContext:function(){this.context.resume()},fetchAudioBuffer:function(t){var i=this;return e[t]?e[t].constructor===Promise?e[t]:Promise.resolve(e[t]):(this.data.cache||Object.keys(e).forEach(function(t){delete e[t]}),e[t]=new Promise(function(a){var n=i.xhr=new XMLHttpRequest;n.open("GET",t),n.responseType="arraybuffer",n.addEventListener("load",function(){function s(i){e[t]=i,a(i)}var o=i.context.decodeAudioData(n.response,s);o&&o.constructor===Promise&&o.then(s).catch(console.error)}),n.send()}),e[t])},getBufferSource:function(){var t=this,i=this.data;return this.fetchAudioBuffer(i.src).then(function(){var a;return(a=t.context.createBufferSource()).buffer=e[i.src],t.el.emit("audioanalyserbuffersource",a,!1),a}).catch(console.error)},getMediaSource:(t={},function(){var e=this.data.src.constructor===String?this.data.src:this.data.src.src;if(t[e])return t[e];this.data.src.constructor===String?(this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous",this.audio.setAttribute("src",this.data.src)):this.audio=this.data.src;var i=this.context.createMediaElementSource(this.audio);return t[e]=i,i})});
//# sourceMappingURL=aframe-audio-analyser.js.map
