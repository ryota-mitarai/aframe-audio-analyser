if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var t={};AFRAME.registerComponent("audioanalyser",{schema:{buffer:{default:!1},beatStartCutoff:{default:.8},beatEndCutoff:{default:.75},cache:{default:!1},enabled:{default:!0},enableBeatDetection:{default:!0},enableLevels:{default:!0},enableWaveform:{default:!0},enableVolume:{default:!0},fftSize:{default:2048},smoothingTimeConstant:{default:.8},src:{parse:function(t){return t.constructor!==String?t:t.startsWith("#")||t.startsWith(".")?document.querySelector(t):t}},unique:{default:!1}},init:function(){this.audioEl=null,this.levels=null,this.waveform=null,this.volume=0,this.xhr=null,this.beat_low=!1,this.beat_mid=!1,this.beat_high=!1,this.beat_low_max=20,this.beat_mid_max=20,this.beat_high_max=20,this.initContext()},update:function(t){var e=this.analyser,i=this.data;t.fftSize===i.fftSize&&t.smoothingTimeConstant===i.smoothingTimeConstant||(e.fftSize=i.fftSize,e.smoothingTimeConstant=i.smoothingTimeConstant,this.levels=new Uint8Array(e.frequencyBinCount),this.waveform=new Uint8Array(e.fftSize)),i.src&&this.refreshSource()},tick:function(t,e){var i=this.data;if(i.enabled){if((i.enableLevels||i.enableVolume)&&this.analyser.getByteFrequencyData(this.levels),i.enableWaveform&&this.analyser.getByteTimeDomainData(this.waveform),i.enableVolume||i.enableBeatDetection){for(var n=0,a=0;a<this.levels.length;a++)n+=this.levels[a];this.volume=n/this.levels.length}if(i.enableBeatDetection){let t=this.beatInRange(1,350,this.beat_low,this.beat_low_max,"audioanalyser-beat-low");this.beat_low=t[0],this.beat_low_max=t[1],t=this.beatInRange(500,2e3,this.beat_mid,this.beat_mid_max,"audioanalyser-beat-mid"),this.beat_mid=t[0],this.beat_mid_max=t[1],t=this.beatInRange(4e3,1e4,this.beat_high,this.beat_high_max,"audioanalyser-beat-high"),this.beat_high=t[0],this.beat_high_max=t[1]}}},beatInRange:function(t,e,i,n,a){const s=this.levels.length,o=Math.floor(t/23600*s),r=Math.floor(e/23600*s),h=this.levels.slice(o,r),u=h.reduce((t,e)=>t+e)/h.length;return u>=(n=Math.max(u,n))*this.data.beatStartCutoff&&0==i?(this.el.emit(a,null,!1),[!0,n]):u<n*this.data.beatEndCutoff&&1==i?[!1,n]:[i,n]},initContext:function(){var t,e=this.data;this.context=new(window.webkitAudioContext||window.AudioContext),t=this.analyser=this.context.createAnalyser(),(this.gainNode=this.context.createGain()).connect(t),t.connect(this.context.destination),t.fftSize=e.fftSize,t.smoothingTimeConstant=e.smoothingTimeConstant,this.levels=new Uint8Array(t.frequencyBinCount),this.waveform=new Uint8Array(t.fftSize)},refreshSource:function(){var t=this.data;t.buffer&&t.src.constructor===String?this.getBufferSource().then(t=>{this.source=t,this.source.connect(this.gainNode)}):(this.source=this.getMediaSource(),this.source.connect(this.gainNode))},suspendContext:function(){this.context.suspend()},resumeContext:function(){this.context.resume()},fetchAudioBuffer:function(e){return t[e]?t[e].constructor===Promise?t[e]:Promise.resolve(t[e]):(this.data.cache||Object.keys(t).forEach(function(e){delete t[e]}),t[e]=new Promise(i=>{const n=this.xhr=new XMLHttpRequest;n.open("GET",e),n.responseType="arraybuffer",n.addEventListener("load",()=>{function a(n){t[e]=n,i(n)}const s=this.context.decodeAudioData(n.response,a);s&&s.constructor===Promise&&s.then(a).catch(console.error)}),n.send()}),t[e])},getBufferSource:function(){var e=this.data;return this.fetchAudioBuffer(e.src).then(()=>{var i;return(i=this.context.createBufferSource()).buffer=t[e.src],this.el.emit("audioanalyserbuffersource",i,!1),i}).catch(console.error)},getMediaSource:function(){const t={};return function(){const e=this.data.src.constructor===String?this.data.src:this.data.src.src;if(t[e])return t[e];this.data.src.constructor===String?(this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous",this.audio.setAttribute("src",this.data.src)):this.audio=this.data.src;const i=this.context.createMediaElementSource(this.audio);return t[e]=i,i}}()});
//# sourceMappingURL=aframe-audio-analyser.modern.js.map
