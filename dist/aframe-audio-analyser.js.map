{"version":3,"file":"aframe-audio-analyser.js","sources":["../src/audioanalyser.js"],"sourcesContent":["if (typeof AFRAME === 'undefined') {\r\n  throw new Error('Component attempted to register before AFRAME was available.');\r\n}\r\n\r\nvar audioBufferCache = {};\r\n\r\n/**\r\n * Audio visualizer component for A-Frame using AnalyserNode.\r\n */\r\nAFRAME.registerComponent('audioanalyser', {\r\n  schema: {\r\n    buffer: { default: false },\r\n    beatStartCutoff: { default: 0.8 },\r\n    beatEndCutoff: { default: 0.75 },\r\n    cache: { default: false },\r\n    enabled: { default: true },\r\n    enableBeatDetection: { default: true },\r\n    enableLevels: { default: true },\r\n    enableWaveform: { default: true },\r\n    enableVolume: { default: true },\r\n    fftSize: { default: 2048 },\r\n    smoothingTimeConstant: { default: 0.8 },\r\n    src: {\r\n      parse: function (val) {\r\n        if (val.constructor !== String) {\r\n          return val;\r\n        }\r\n        if (val.startsWith('#') || val.startsWith('.')) {\r\n          return document.querySelector(val);\r\n        }\r\n        return val;\r\n      },\r\n    },\r\n    unique: { default: false },\r\n  },\r\n\r\n  init: function () {\r\n    this.audioEl = null;\r\n    this.levels = null;\r\n    this.waveform = null;\r\n    this.volume = 0;\r\n    this.xhr = null;\r\n\r\n    this.beat_low = false;\r\n    this.beat_mid = false;\r\n    this.beat_high = false;\r\n    this.beat_low_max = 20;\r\n    this.beat_mid_max = 20;\r\n    this.beat_high_max = 20;\r\n\r\n    this.initContext();\r\n  },\r\n\r\n  update: function (oldData) {\r\n    const analyser = this.analyser;\r\n    const data = this.data;\r\n\r\n    // Update analyser stuff.\r\n    if (oldData.fftSize !== data.fftSize || oldData.smoothingTimeConstant !== data.smoothingTimeConstant) {\r\n      analyser.fftSize = data.fftSize;\r\n      analyser.smoothingTimeConstant = data.smoothingTimeConstant;\r\n      this.levels = new Uint8Array(analyser.frequencyBinCount);\r\n      this.waveform = new Uint8Array(analyser.fftSize);\r\n    }\r\n\r\n    if (!data.src) {\r\n      return;\r\n    }\r\n    this.refreshSource();\r\n  },\r\n\r\n  /**\r\n   * Update spectrum on each frame.\r\n   */\r\n  tick: function () {\r\n    const data = this.data;\r\n\r\n    if (!data.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Levels (frequency).\r\n    if (data.enableLevels || data.enableVolume) {\r\n      this.analyser.getByteFrequencyData(this.levels);\r\n    }\r\n\r\n    // Waveform.\r\n    if (data.enableWaveform) {\r\n      this.analyser.getByteTimeDomainData(this.waveform);\r\n    }\r\n\r\n    // Average volume.\r\n    if (data.enableVolume || data.enableBeatDetection) {\r\n      var sum = 0;\r\n      for (var i = 0; i < this.levels.length; i++) {\r\n        sum += this.levels[i];\r\n      }\r\n      this.volume = sum / this.levels.length;\r\n    }\r\n\r\n    // Beat detection.\r\n    if (data.enableBeatDetection) {\r\n      //frequencies here are on a scale of 0 - 23600hz\r\n      var val = this.beatInRange(1, 350, this.beat_low, this.beat_low_max, 'audioanalyser-beat-low');\r\n      this.beat_low = val[0];\r\n      this.beat_low_max = val[1];\r\n      val = this.beatInRange(500, 2000, this.beat_mid, this.beat_mid_max, 'audioanalyser-beat-mid');\r\n      this.beat_mid = val[0];\r\n      this.beat_mid_max = val[1];\r\n      val = this.beatInRange(4000, 10000, this.beat_high, this.beat_high_max, 'audioanalyser-beat-high');\r\n      this.beat_high = val[0];\r\n      this.beat_high_max = val[1];\r\n    }\r\n  },\r\n\r\n  //uses fourier transforms to detect beats in a given frequency range\r\n  beatInRange: function (_start, _end, _lastBeat, beat_max, _emitName) {\r\n    const frequencyLength = this.levels.length;\r\n    const adjStart = Math.floor((_start / 23600) * frequencyLength);\r\n    const adjEnd = Math.floor((_end / 23600) * frequencyLength);\r\n\r\n    const slice = this.levels.slice(adjStart, adjEnd);\r\n    const average = slice.reduce((a, b) => a + b) / slice.length;\r\n\r\n    beat_max = Math.max(average, beat_max);\r\n\r\n    if (average >= beat_max * this.data.beatStartCutoff && _lastBeat == false) {\r\n      this.el.emit(_emitName, null, false);\r\n      return [true, beat_max];\r\n    } else if (average < beat_max * this.data.beatEndCutoff && _lastBeat == true) {\r\n      return [false, beat_max];\r\n    }\r\n    return [_lastBeat, beat_max];\r\n  },\r\n\r\n  initContext: function () {\r\n    const data = this.data;\r\n\r\n    this.context = new (window.webkitAudioContext || window.AudioContext)();\r\n    const analyser = (this.analyser = this.context.createAnalyser());\r\n    const gainNode = (this.gainNode = this.context.createGain());\r\n    gainNode.connect(analyser);\r\n    analyser.connect(this.context.destination);\r\n    analyser.fftSize = data.fftSize;\r\n    analyser.smoothingTimeConstant = data.smoothingTimeConstant;\r\n    this.levels = new Uint8Array(analyser.frequencyBinCount);\r\n    this.waveform = new Uint8Array(analyser.fftSize);\r\n  },\r\n\r\n  refreshSource: function () {\r\n    const data = this.data;\r\n\r\n    if (data.buffer && data.src.constructor === String) {\r\n      this.getBufferSource().then((source) => {\r\n        this.source = source;\r\n        this.source.connect(this.gainNode);\r\n      });\r\n    } else {\r\n      this.source = this.getMediaSource();\r\n      this.source.connect(this.gainNode);\r\n    }\r\n  },\r\n\r\n  suspendContext: function () {\r\n    this.context.suspend();\r\n  },\r\n\r\n  resumeContext: function () {\r\n    this.context.resume();\r\n  },\r\n\r\n  /**\r\n   * Fetch and parse buffer to audio buffer. Resolve a source.\r\n   */\r\n  fetchAudioBuffer: function (src) {\r\n    // From cache.\r\n    if (audioBufferCache[src]) {\r\n      if (audioBufferCache[src].constructor === Promise) {\r\n        return audioBufferCache[src];\r\n      } else {\r\n        return Promise.resolve(audioBufferCache[src]);\r\n      }\r\n    }\r\n\r\n    if (!this.data.cache) {\r\n      Object.keys(audioBufferCache).forEach(function (src) {\r\n        delete audioBufferCache[src];\r\n      });\r\n    }\r\n\r\n    audioBufferCache[src] = new Promise((resolve) => {\r\n      // Fetch if does not exist.\r\n      const xhr = (this.xhr = new XMLHttpRequest());\r\n      xhr.open('GET', src);\r\n      xhr.responseType = 'arraybuffer';\r\n      xhr.addEventListener('load', () => {\r\n        // Support Webkit with callback.\r\n        function cb(audioBuffer) {\r\n          audioBufferCache[src] = audioBuffer;\r\n          resolve(audioBuffer);\r\n        }\r\n        const res = this.context.decodeAudioData(xhr.response, cb);\r\n        if (res && res.constructor === Promise) {\r\n          res.then(cb).catch(console.error);\r\n        }\r\n      });\r\n      xhr.send();\r\n    });\r\n    return audioBufferCache[src];\r\n  },\r\n\r\n  getBufferSource: function () {\r\n    const data = this.data;\r\n    return this.fetchAudioBuffer(data.src)\r\n      .then(() => {\r\n        const source = this.context.createBufferSource();\r\n        source.buffer = audioBufferCache[data.src];\r\n        this.el.emit('audioanalyserbuffersource', source, false);\r\n        return source;\r\n      })\r\n      .catch(console.error);\r\n  },\r\n\r\n  getMediaSource: (function () {\r\n    const nodeCache = {};\r\n\r\n    return function () {\r\n      const src = this.data.src.constructor === String ? this.data.src : this.data.src.src;\r\n      if (nodeCache[src]) {\r\n        return nodeCache[src];\r\n      }\r\n\r\n      if (this.data.src.constructor === String) {\r\n        this.audio = document.createElement('audio');\r\n        this.audio.crossOrigin = 'anonymous';\r\n        this.audio.setAttribute('src', this.data.src);\r\n      } else {\r\n        this.audio = this.data.src;\r\n      }\r\n      const node = this.context.createMediaElementSource(this.audio);\r\n\r\n      nodeCache[src] = node;\r\n      return node;\r\n    };\r\n  })(),\r\n});\r\n"],"names":["AFRAME","Error","nodeCache","audioBufferCache","registerComponent","schema","buffer","default","beatStartCutoff","beatEndCutoff","cache","enabled","enableBeatDetection","enableLevels","enableWaveform","enableVolume","fftSize","smoothingTimeConstant","src","parse","val","constructor","String","startsWith","document","querySelector","unique","init","this","audioEl","levels","waveform","volume","xhr","beat_low","beat_mid","beat_high","beat_low_max","beat_mid_max","beat_high_max","initContext","update","oldData","analyser","data","Uint8Array","frequencyBinCount","refreshSource","tick","getByteFrequencyData","getByteTimeDomainData","sum","i","length","beatInRange","_start","_end","_lastBeat","beat_max","_emitName","frequencyLength","adjStart","Math","floor","adjEnd","slice","average","reduce","a","b","max","el","emit","context","window","webkitAudioContext","AudioContext","createAnalyser","gainNode","createGain","connect","destination","getBufferSource","then","source","_this","getMediaSource","suspendContext","suspend","resumeContext","resume","fetchAudioBuffer","Promise","resolve","Object","keys","forEach","_this2","XMLHttpRequest","open","responseType","addEventListener","cb","audioBuffer","res","decodeAudioData","response","console","error","send","_this3","createBufferSource","audio","createElement","crossOrigin","setAttribute","node","createMediaElementSource"],"mappings":"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"}